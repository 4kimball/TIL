# 서버와 연결 끊기

> 클라이언트와 서버간에 데이터 송수신이 모두 이루어졌으면 소켓을 말소하여 연결을 끊는다.



### :one: 데이터를 모두 보냈을 때 연결을 끊는다.

- 클라이언트와 서버에서는 상대방이 원하는 데이터를 모두 보냈을 때 연결을 끊을 수 있다. 
- 하지만 여기서는 헷갈리지않게 서버를 기준으로 설명한다.
- 서버는 연결을 끊기위해 Socket 라이브러리인 close를 실행한다. 
- 그 다음 프로토콜 스택이 TCP 헤더를 만들며 컨트롤 비트인 FIN비트에 1을 설정하고, IP에 의뢰하여 클라이언트에 전송한다.
- FIN을 1로 설정한 TCP 헤더를 클라이언트 측에서 받는다면 다시 ACK를 반송하고, 프로토콜 스택은 애플리케이션이 read 하기를 기다린다.
- 애플래케이션이 read를 했을 때 더 이상 받을 데이터가 없다고 알려준다. 웹은 서버에서 보낸 데이터를 모두 수신하면 종료되도록 정해져있다.



### :two: 소켓 말소하기

- 소켓을 말소한다는 것은 클라이언트와 서버의 통신에서 사용된 파이프를 없앤다는 것이다.
- 하지만 바로 소켓을 말소하지않고 기다린다.
- 이유는 다양하지만 대표적인 것은 다음과 같다.
- 서버에서 FIN을 보내고 클라이언트에서 FIN을 받았다는 ACK를 반송한다. 하지만 중간에 ACK신호가 사라져서 서버에서는 다시 FIN을 보내려고 한다. 하지만 소켓을 바로 말소했으면 같은 번호의 소켓이 전달받고 바로 종료가 될 것이다.
- 이를 방지하기 위해 소켓은 보통 몇 분의 시간을 기다린다. 받아야하는 패킷이 네트워크 상에 존재할 수도 있기 때문이다.

